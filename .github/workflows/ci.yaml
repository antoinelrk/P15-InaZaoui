name: CI - Release Next

on:
  push:
    branches:
      - step-8/add-pipeline
      - release/next

jobs:
  test-suite:
    name: Test suite (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest]
        php: ['8.4']

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Start Docker stack
        run: |
          docker compose -f compose.yaml up -d --build

      - name: Setup project
        run: |
          docker exec -it ina_zaoui_postgres psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS ina_zaoui WITH (FORCE);"
          docker exec -it ina_zaoui_postgres psql -U postgres -d postgres -c "CREATE DATABASE ina_zaoui;"
          docker exec -it ina_zaoui_postgres psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS ina_zaoui_test WITH (FORCE);"
          docker exec -it ina_zaoui_postgres psql -U postgres -d postgres -c "CREATE DATABASE ina_zaoui_test;"
          php bin/console doctrine:schema:update --force
          docker exec -it ina_zaoui_app php bin/console doctrine:fixtures:load --no-interaction

    #   - name: Build frontend assets
    #     run: |
    #       php bin/console sass:build

    #   - name: Run PHPUnit tests
    #     run: |
    #       php bin/phpunit

    #   - name: Run static analysis
    #     run: |
    #       php -d memory_limit=1G vendor/bin/phpstan
